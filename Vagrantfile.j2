Vagrant.configure("2") do |config|
{% for n in nodes %}
{%   set name = n.name %}
  config.vm.define "{{ name }}" do |{{name}}|
{%   if n.mgmt_mac is defined %}
    {{ name }}.vm.provider :libvirt do |domain|
      domain.management_network_mac = "{{n.mgmt_mac}}"
    end
{%   endif %}
{%  include "Vagrantfile." ~ n.device ~ ".j2" %}
#
{%   for l in n.links %}
{%     if 'bridge' in l: %}
    {{ name }}.vm.network :private_network,
                  :libvirt__network_name => "{{ l.bridge }}",
                  :libvirt__forward_mode => "veryisolated",
                  :libvirt__dhcp_enabled => false,
                  :libvirt__iface_name => "vgif_{{name}}_{{l.ifindex}}",
                  :auto_config => false
{%     else %}
    {{ name }}.vm.network :private_network,
                  :libvirt__tunnel_type => "udp",
                  :libvirt__tunnel_local_ip => "127.1.{{ n.id }}.{{ l.ifindex }}",
                  :libvirt__tunnel_local_port => "{{ 10000 + l.ifindex}}",
                  :libvirt__tunnel_ip => "127.1.{{ l.remote_id}}.{{ l.remote_ifindex }}",
                  :libvirt__tunnel_port => "{{ 10000 + l.remote_ifindex}}",
                  :libvirt__iface_name => "vgif_{{name}}_{{l.ifindex}}",
                  auto_config: false
{%     endif %}
{%   endfor %}
  end
{% endfor %}
end
