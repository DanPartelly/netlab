{% set has_v6 = [] %}
{% for pool in dhcp.pools|default([]) %}
{%   if pool.excluded.ipv4 is defined %}
{%     for xa in pool.excluded.ipv4 %}
ip dhcp excluded-address {{ xa }}
{%     endfor %}
!
{%   endif %}
{%   if pool.ipv4 is defined %}
ip dhcp pool {{ pool.clean_name }}
 network {{ pool.ipv4.split('/')[0] }} {{ pool.ipv4|ipaddr('netmask') }}
{%     if pool.gateway.ipv4 is defined %}
 default-router {{ pool.gateway.ipv4 }}
{%     endif %}
{%   endif %}
{%   if pool.ipv6 is defined %}
!
{% set ignore = has_v6.append(pool.name) %}
ipv6 dhcp pool {{ pool.clean_name }}
 address prefix {{ pool.ipv6 }}
{%   endif %}
{% endfor %}
{% if has_v6 %}
{%   for intf in interfaces %}
!
interface {{ intf.ifname }}
 ipv6 dhcp server
{%   endfor %}
{% endif %}
